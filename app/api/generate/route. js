import { GoogleGenAI } from "@google/genai";
import { NextResponse } from 'next/server';

// تهيئة Gemini API: يتم جلب المفتاح تلقائيًا من متغيرات البيئة (GEMINI_API_KEY)
// هذا يحافظ على أمان مفتاحك ولا يجعله مرئيًا في الكود الأمامي.
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });

// هذا هو "الأمر الذهبي" الرئيسي الذي صممناه سابقًا.
const MASTER_PROMPT_TEMPLATE = (userIdea) => `
  أنت مساعد تصميم إبداعي متخصص في التسويق الثقافي العربي. مهمتك هي تحويل فكرة بسيطة من المستخدم إلى ثلاثة عناصر تصميم متكاملة: 1) نص تسويقي جذاب، 2) أسلوب تصميم بصري مقترح، 3) أمر صور (Prompt) مفصل لـ AI Image Generator.

  [تعليمات المستخدم]: ${userIdea}

  يجب أن يكون الإخراج بصيغة JSON فقط لتسهيل قراءته في التطبيق. يجب أن يكون JSON بالشكل التالي:
  {
      "copywriting_title": "العنوان الجذاب المقترح",
      "copywriting_body": "النص التسويقي القصير والواضح (بحد أقصى 30 كلمة)",
      "visual_style": "وصف الأسلوب البصري المقترح باللغة العربية مع لوحة الألوان (مثال: نيون، كلاسيكي، ألوان بنية دافئة)",
      "image_prompt": "صياغة أمر توليد الصورة (AI Image Prompt) مفصل باللغة الإنجليزية لضمان أفضل جودة إخراج."
  }
`;

export async function POST(request) {
  try {
    // 1. قراءة بيانات المستخدم من طلب الـ POST
    const { idea } = await request.json();

    if (!idea) {
      return NextResponse.json({ error: "الرجاء إدخال فكرة التصميم." }, { status: 400 });
    }

    // 2. دمج الأمر الذهبي وفكرة المستخدم
    const fullPrompt = MASTER_PROMPT_TEMPLATE(idea);

    // 3. إرسال الطلب إلى Gemini (باستخدام نموذج قوي مثل Gemini 2.5 Pro)
    const response = await ai.models.generateContent({
      model: "gemini-2.5-pro", 
      contents: fullPrompt,
      config: {
          // توجيه النموذج لإخراج JSON فقط لضمان التنسيق
          responseMimeType: "application/json",
      },
    });

    // 4. تحليل النتيجة وإعادتها
    const jsonText = response.text.trim();
    // تحويل النص المستلم إلى كائن JavaScript (JSON)
    const result = JSON.parse(jsonText); 

    // إرجاع النتيجة المنظمة للمستخدم
    return NextResponse.json(result);

  } catch (error) {
    console.error("Gemini API Error:", error);
    // إرسال رسالة خطأ واضحة للمستخدم
    return NextResponse.json(
      { error: "حدث خطأ في محرك الذكاء الاصطناعي. تأكد من أن مفتاح الـ API صحيح." }, 
      { status: 500 }
    );
  }
}
